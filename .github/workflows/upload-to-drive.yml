name: Upload Release to Google Drive

on:
  release:
    types: [published]

jobs:
  upload:
    runs-on: ubuntu-latest
    steps:
      - name: Get asset info and download
        run: |
          ASSET_NAME=$(echo '${{ toJson(github.event.release.assets) }}' | python3 -c "
          import json, sys
          assets = json.load(sys.stdin)
          exe = [a for a in assets if a['name'].endswith('.exe')]
          if exe:
              print(exe[0]['name'])
          ")
          ASSET_URL=$(echo '${{ toJson(github.event.release.assets) }}' | python3 -c "
          import json, sys
          assets = json.load(sys.stdin)
          exe = [a for a in assets if a['name'].endswith('.exe')]
          if exe:
              print(exe[0]['browser_download_url'])
          ")
          echo "ASSET_NAME=$ASSET_NAME" >> $GITHUB_ENV
          wget -O "$ASSET_NAME" "$ASSET_URL"
          ls -la

      - name: Install dependencies
        run: pip install google-api-python-client google-auth

      - name: Upload to Google Drive
        env:
          GOOGLE_SERVICE_ACCOUNT_KEY: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_KEY }}
          GDRIVE_FOLDER_ID: ${{ secrets.GDRIVE_FOLDER_ID }}
          ASSET_NAME: ${{ env.ASSET_NAME }}
        run: |
          python3 << 'EOF'
          import os
          import json
          from googleapiclient.discovery import build
          from googleapiclient.http import MediaFileUpload
          from google.oauth2 import service_account

          credentials_json = os.environ['GOOGLE_SERVICE_ACCOUNT_KEY']
          folder_id = os.environ['GDRIVE_FOLDER_ID']
          asset_name = os.environ['ASSET_NAME']

          credentials_info = json.loads(credentials_json)
          credentials = service_account.Credentials.from_service_account_info(
              credentials_info,
              scopes=['https://www.googleapis.com/auth/drive']
          )

          service = build('drive', 'v3', credentials=credentials)

          file_metadata = {
              'name': asset_name,
              'parents': [folder_id]
          }

          media = MediaFileUpload(asset_name, resumable=True)

          results = service.files().list(
              q=f"name='{asset_name}' and '{folder_id}' in parents",
              fields="files(id, name)"
          ).execute()
          for f in results.get('files', []):
              service.files().delete(fileId=f['id']).execute()
              print(f"Deleted existing file: {f['name']}")

          file = service.files().create(
              body=file_metadata,
              media_body=media,
              fields='id, name, webViewLink'
          ).execute()

          print(f"Uploaded: {file.get('name')}")
          print(f"File ID: {file.get('id')}")
          print(f"Link: {file.get('webViewLink')}")
          EOF
