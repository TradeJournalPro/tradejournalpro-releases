name: Upload Release to Google Drive

on:
  release:
    types: [published]

jobs:
  upload:
    runs-on: ubuntu-latest
    steps:
      - name: Download release asset
        run: |
          ASSET_NAME=$(echo '${{ toJson(github.event.release.assets) }}' | python3 -c "
          import json, sys
          assets = json.load(sys.stdin)
          exe = [a for a in assets if a['name'].endswith('.exe')]
          if exe:
              print(exe[0]['name'])
          ")
          ASSET_URL=$(echo '${{ toJson(github.event.release.assets) }}' | python3 -c "
          import json, sys
          assets = json.load(sys.stdin)
          exe = [a for a in assets if a['name'].endswith('.exe')]
          if exe:
              print(exe[0]['browser_download_url'])
          ")
          echo "ASSET_NAME=$ASSET_NAME" >> $GITHUB_ENV
          wget -O "$GITHUB_WORKSPACE/$ASSET_NAME" "$ASSET_URL"

      - name: Upload to Google Drive
        uses: adityak74/google-drive-upload-git-action@main
        with:
          credentials: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_KEY }}
          filename: ${{ env.ASSET_NAME }}
          folderId: ${{ secrets.GDRIVE_FOLDER_ID }}
          overwrite: true
